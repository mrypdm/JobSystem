@startuml Worker loop

title Обработка задач

control "Обработчик задач" as WORKER
control "Анализатор окружения" as ENV_AN
boundary "Окружение" as ENV
control "Исполнитель задач" as RUNNER
queue "Очередь задач" as KAFKA
database "БД Задач" as DB

== Инициализация ==

WORKER -> KAFKA++: Подпись на очередь Задач
KAFKA --> WORKER: Возврат
WORKER -> WORKER++: Запуск цикла обработки

== Обработка задач ==

loop #LightGray До запроса завершения

WORKER --> WORKER++: Старт итерации
WORKER -> ENV_AN++: Анализ возможности запуска Задачи

ENV_AN -> ENV++: Сбор статистики об окружении
ENV -> ENV_AN--: Статистика об окружении
ENV_AN -> RUNNER++: Запрос текущего количества исполняемых Задач
RUNNER -> ENV_AN--: Число запущеных Задач
ENV_AN -> WORKER--: Результат анализа

alt #LightSteelBlue Запуск возможен

    WORKER -> KAFKA++: Ожидание сообщения о новой Задачи
    KAFKA -> WORKER--: Ответ номера новой Задачи
    WORKER -> DB++: Запрос данных новой Задачи
    DB -> WORKER--: Ответ данных новой Задачи

    alt #PowderBlue Задача существует и не была запущена ранее

        WORKER -> RUNNER++: Запуск задачи
        RUNNER --> WORKER--: Возврат

        WORKER -> DB++: Пометка задачи, как запущенной
        DB --> WORKER--: Возврат

    else #Pink Задача не существует или была запущена ранее

        WORKER -> WORKER: Пропуск запуска задачи

    end

    WORKER -> KAFKA++: Пометка сообщения, как обработанного
    KAFKA --> WORKER--: Возврат

end

    WORKER -> WORKER--: Конец итерации и ожидаение следующей итерации

end

== Завершение ==

WORKER -> WORKER--: Остановка цикла обработки
WORKER -> KAFKA: Отписка от очереди задач
KAFKA --> WORKER--: Возврат
WORKER -> RUNNER++: Ожидание завершения уже запущенных задач
RUNNER --> WORKER--: Возврат

@enduml

@startuml Job runner

title Исполнение задач

control "Запуск задач" as STARTER
control "Исполнение задач" as RUNNER
database "БД Задач" as DB
control "Сборщик результатов" as COLLECTOR
boundary "Docker API" as DOCKER
boundary "Окружение" as ENV

[-> STARTER++: Запрос исполнения Задачи
STARTER -> STARTER: Проверка, что Задача уже запущена

alt #Pink Задач уже запущена

    STARTER -> STARTER: Пропуск запуска
    STARTER -->[: Возврат

else #LightSteelBlue Новая Задача

    STARTER -> RUNNER++: Cтарт исполнения Задачи
    RUNNER --> STARTER: Возврат
    STARTER -> STARTER: Сохранение задачи в список запущенных Задач
    STARTER -->[--: Возврат

    RUNNER -> ENV++: Подготовка окружения для исполнения Задачи

    RUNNER -> DOCKER++: Запуск процесса задачи и ожидание его завершения
    DOCKER -> DOCKER: Создание контейнера
    DOCKER -> DOCKER: Запуск контейнера
    DOCKER -> DOCKER: Остановка контейнера
    DOCKER -> DOCKER: Удаление контейнера
    DOCKER --> RUNNER--: Возврат

    alt #PowderBlue Процесс завершен успешно

        RUNNER -> COLLECTOR++: Сбор результатов Задачи
        COLLECTOR -> ENV: Запрос файлов-результатов задачи
        ENV -> COLLECTOR: Файлы-результаты задачи
        COLLECTOR -> COLLECTOR: Архивация результатов задачи
        COLLECTOR -> RUNNER--: Возврат результатов в виде ZIP архива

        RUNNER -> DB++: Сохранение результатов задачи и пометка ее, как завершенной
        DB --> RUNNER--: Возврат
        note right: Результатом может быть "успех" или "таймаут"

    else #Pink Процесс завершен с ошибками

        RUNNER -> DB++: Пометка задачи, как проваленной
        DB --> RUNNER--: Возврат

    end

    RUNNER -> ENV: Очистка окружения задачи
    ENV --> RUNNER--: Возврат

    RUNNER -> STARTER--: Удаление задачи из списка запущенных задач

end

@enduml
